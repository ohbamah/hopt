name: Create Release

env:
  VERSION: 2.0.1

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.get_version.outputs.VERSION }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set version from env
      id: get_version
      run: |
        VERSION="v${{ env.VERSION }}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Create tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ steps.get_version.outputs.VERSION }} || echo "Tag already exists"
        git push origin ${{ steps.get_version.outputs.VERSION }} || echo "Tag already pushed"

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Hopt ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ðŸš€ Release ${{ steps.get_version.outputs.VERSION }}
          
          **Commit:** ${{ github.sha }}
          **Date:** ${{ github.event.head_commit.timestamp }}
          **Author:** ${{ github.event.head_commit.author.name }}

          ### ðŸ“ Last changes
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-artifacts:
    needs: create-release
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            archive_name: libhopt-linux-x64.tar.gz
          - os: macos-latest
            platform: macos-x64
            archive_name: libhopt-macos-x64.tar.gz
          - os: windows-latest
            platform: windows-x64
            archive_name: libhopt-windows-x64.zip

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup MSYS2 (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-clang
          mingw-w64-x86_64-make
          make
          zip
    - name: Build library (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        make
    - name: Prepare release package (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        mkdir -p release-package/hopt
        mv libhopt.a release-package/hopt/libhopt.lib
        mv includes/hopt.h release-package/hopt/
        mv LICENSE release-package/hopt/
        mv README.md release-package/hopt/
        echo "# HOPT ${{ github.ref_name }} - ${{ matrix.platform }} - ${{ env.VERSION }}" > release-package/hopt/VERSION.txt
        echo "Compiled on: $(date)" >> release-package/hopt/VERSION.txt
        echo "Plateform: ${{ matrix.platform }}" >> release-package/hopt/VERSION.txt
        cd release-package
        zip -r ../${{ matrix.archive_name }} hopt/

    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang make
    - name: Build library (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        make
    - name: Prepare release package (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir -p release-package/hopt
        mv libhopt.a release-package/hopt/
        mv includes/hopt.h release-package/hopt/
        mv LICENSE release-package/hopt/
        mv README.md release-package/hopt/
        echo "# HOPT ${{ github.ref_name }} - ${{ matrix.platform }}" > release-package/hopt/VERSION.txt
        echo "Compiled on: $(date)" >> release-package/hopt/VERSION.txt
        echo "Plateform: ${{ matrix.platform }}" >> release-package/hopt/VERSION.txt
        cd release-package
        tar -czf ../${{ matrix.archive_name }} hopt/

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./${{ matrix.archive_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-latest:
    needs: [create-release, build-artifacts]
    runs-on: ubuntu-latest
    steps:
    - name: Update latest release
      uses: actions/github-script@v8
      with:
        script: |
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: ${{ needs.create-release.outputs.release_id }},
            make_latest: true
          });
